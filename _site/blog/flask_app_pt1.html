<!DOCTYPE html>
<html lang="en-us">
	
  <!-- google_analytic file -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61555722-1', 'auto');
  ga('send', 'pageview');

</script>
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  

  

  <!-- CSS -->
  

  
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Ubuntu:400,400italic,700">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <title>
    
      A simple data viz app using Flask and D3 - Part 1
      James Gardiner
    
  </title>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  
  <div class="sidebar-logo">
    <img src="http://www.gravatar.com/avatar/64efb4611c5f7a0f48d81a92c61e64e4?s=120" />
  </div>

  <div id="contact-list" style="text-align:center">
    
      <a href="https://github.com/jamesGardiner">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-github-alt fa-stack-1x"></i>
        </span>
      </a>
    
  
      <a href="https://twitter.com/James_G87">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-twitter fa-stack-1x"></i>
        </span>
      </a>
    

    
      <a href="https://linkedin.com/in/jrgardiner">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-linkedin fa-stack-1x"></i>
        </span>
      </a>
    
  </div>

  <div class="sidebar-item">
    <p>A site for my analyses, findings, musings and other helpful tidbits.</p>
  </div>
  
  <ul>
    
    <li><a href="/blog/fitbit-data-analysis">Fitbit Data Analysis</a></li>
    
    <li><a href="/blog/flask_app_pt1">A simple data viz app using Flask and D3 - Part 1</a></li>
    
    <li><a href="/blog/police_data_api_in_leaflet_part2">Using the data.police.uk API with Leaflet - part 2</a></li>
    
    <li><a href="/blog/police_data_api_in_leaflet_part1">Using the data.police.uk API with Leaflet</a></li>
    
    <li><a href="/blog/a-basic-leaflet-map-in-jekyll">A basic Leaflet.js map in Jekyll</a></li>
    
  </ul>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    
	
    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About me</a>
        
      
    
    <!--<a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>-->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">James Gardiner</a>
            <br />
            <small>A personal data analysis repo</small>
          </h3>
        </div>
      </div>
      <div class="container content">
	    <div class="post">
  <h1 class="post-title">A simple data viz app using Flask and D3 - Part 1</h1>
  <span class="post-date">22 Nov 2015</span>
  <p>In this post I’ll cover the set-up of a simple <a href="http://flask.pocoo.org/">Flask</a> data visualisation project using D3.js backed by a postgresql database. The instructions are aimed at OS X users, but Windows and Linux users should get a good idea of what is required in each step.</p>

<hr />
<!--more-->

<p>The data we’ll be looking at is <a href="https://statswales.wales.gov.uk/Catalogue/Local-Government/Finance/Revenue/Budgets/budgetedrevenueexpenditure-by-authority-service"><em>Budgeted revenue expenditure by authority and service</em></a> which shows the revenue expenditure of Welsh local authorities, police authorities, fire authorities and national park authorities on services such as education and social care.</p>

<p><a href="http://flask.pocoo.org/">Flask</a> is a microframework for Python that has been around since 2010. It’s easier to setup and develop basic web-apps with than the more fully featured Django framework, and is especially ideal for rapid prototyping of ideas.</p>

<p><a href="http://www.postgresql.org/about/">PostgreSQL</a> is a powerful, mature and open-source object-relational database system that has been in active development for over 15 years. And luckily for us, it plays really well with Python via the <a href="http://initd.org/psycopg/">Pyscopg</a> package. For me, nothing comes close to Postgres in terms of storing and querying lasrge geospatial data sets via the <a href="http://postgis.net/">PostGIS</a> database extension, which is core to my day-to-day.</p>

<p>I’ll also be throwing some client side JavaScript into the mix, mainly <a href="http://bost.ocks.org/mike/">Mike Bostock’s</a> amazing Data-Driven-Documents JS library, or <a href="http://d3js.org/">D3.js</a>, for visualising our data in the browser.</p>

<h2 id="setup-postgresql">Setup PostgreSQL</h2>
<p>There’s a fair few ways to install PostgreSQL to OS X; personally, I follow <a href="http://ivanstorck.com/">Ivan Storck’s</a> method for OS X <a href="https://www.codefellows.org/blog/three-battle-tested-ways-to-install-postgresql">here</a>. Come back once PostgreSQL is up and running.</p>

<p>All set? Great, lets create a new database and a user role to access the database. In a terminal type the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">createdb flask_app
createuser flask_user</code></pre></figure>

<p>This creates the database we wil connect to, and the role we will use to connect to it.</p>

<h3 id="setup-flask">Setup Flask</h3>

<p>First off, <code class="highlighter-rouge">cd</code> into the directory that you’ll be setting the project up in. I keep all my local Python dev inside a <code class="highlighter-rouge">~/Virtualenv</code> folder. Setup a new folder here and name it whatever you like; I’ll call mine FlaskApp:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir FlaskApp</code></pre></figure>

<p>Then use <a href="https://virtualenv.readthedocs.org/en/latest/">virtualenv</a> or the really useful <a href="https://virtualenvwrapper.readthedocs.org/en/latest/">virtualenvwrapper</a> to setup a virtual environment in which we will develop our application. If you need to, go install these tools and learn about their use, as they will save a lot of headaches further down the line.</p>

<p>Now, using virtualenvwrapper, issue the following command to create a new virtual environment, assosciate a directory with it and activate it once its setup:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>FlaskApp
mkvirtualenvwrapper -a . FlaskApp</code></pre></figure>

<p>Your command prompt should now have <code class="highlighter-rouge">(FlaskApp)</code> at the start, signifying that the virtual environment is active, so lets install Flask and other dependencies:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip install Flask
pip install Flask-Script</code></pre></figure>

<p>To check that everything is working, we can create a simple Flask app and run it via the built in Flask development server.  Note that this server is  for development purposes only, and shouldn’t be used in a production environment. See the <a href="http://flask.pocoo.org/docs/0.10/server/">Flask development server pages</a> for more info.</p>

<p>First, make the following directories in your working directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir project/templates</code></pre></figure>

<p>Then add an HTML file called <code class="highlighter-rouge">index.html</code> in the <code class="highlighter-rouge">templates</code> directory.</p>

<p>Create a file called <code class="highlighter-rouge">hello.py</code> in your project folder which contains the following code. The app.run() method is called when the module is run as the main program:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></code></pre></figure>

<p>Run <code class="highlighter-rouge">python hello.py</code> at the command line to invoke the Flask development server. Navigate over to <code class="highlighter-rouge">http://127.0.0.1:5000</code> and, if everything is setup correctly, you’ll see a simple web page with ‘Hello world!’ at the top.</p>

<p>Note that a Command Line Interface (CLI) comes bundled as part of Flask 1.0, and you can use it to run Flask apps as follows:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">flask -a hello run</code></pre></figure>

<h2 id="get-the-data">Get the data!</h2>
<p>So before we go any further, lets get the data and make it useable. First download the data file in csv format from <a href="https://statswales.wales.gov.uk/Catalogue/Local-Government/Finance/Revenue/Budgets/budgetedrevenueexpenditure-by-authority-service">here</a>, and then install a few more module dependencies:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pip</span> <span class="n">install</span> <span class="n">sqlalchemy</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">psycopg2</span></code></pre></figure>

<p>I’ve used the pandas library to shape the data to fit our needs using the following code. Notice the sqlalchemy import at the top, which we will use to get the data into our Postgres instance:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create</span> <span class="n">engine</span>

<span class="c"># Read the csv into a pandas dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'/path/to/export.csv'</span><span class="p">)</span>

<span class="c"># Drop unused columns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'Unnamed: 0'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Merge the first two columns where there are NaNs</span>
<span class="n">df</span><span class="p">[</span><span class="s">'Unnamed: 2'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Unnamed: 1'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Then delete the first column</span>
<span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s">'Unnamed: 1'</span><span class="p">]</span>

<span class="c"># And rename the first entry to 'Wales'</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s">'Unnamed: 2'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Wales'</span>

<span class="c"># Rename columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Unnamed: 2'</span><span class="p">:</span> <span class="s">'Area'</span><span class="p">,</span> <span class="s">'.'</span><span class="p">:</span> <span class="s">'Total'</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span></code></pre></figure>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/fitbit-data-analysis">
            Fitbit Data Analysis
            <small>03 Apr 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/police_data_api_in_leaflet_part2">
            Using the data.police.uk API with Leaflet - part 2
            <small>05 May 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/police_data_api_in_leaflet_part1">
            Using the data.police.uk API with Leaflet
            <small>05 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

	    <a href="https://twitter.com/share" class="twitter-share-button" data-via="<James_G87>">Tweet</a>

<!-- Put this just before the closing body tag -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	    <!-- disquss file -->

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jamesgardiner'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <div class="footer">
          <p>
          &copy; James Gardiner 2016. All rights reserved.
          </p>
        </div>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
	
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
