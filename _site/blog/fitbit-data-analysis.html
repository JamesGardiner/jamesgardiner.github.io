<!DOCTYPE html>
<html lang="en-us">
	
  <!-- google_analytic file -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61555722-1', 'auto');
  ga('send', 'pageview');

</script>
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  

  

  <!-- CSS -->
  

  
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Ubuntu:400,400italic,700">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <title>
    
      Fitbit Data Analysis
      James Gardiner
    
  </title>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  
  <div class="sidebar-logo">
    <img src="http://www.gravatar.com/avatar/64efb4611c5f7a0f48d81a92c61e64e4?s=120" />
  </div>

  <div id="contact-list" style="text-align:center">
    
      <a href="https://github.com/jamesGardiner">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-github-alt fa-stack-1x"></i>
        </span>
      </a>
    
  
      <a href="https://twitter.com/_JamesRG">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-twitter fa-stack-1x"></i>
        </span>
      </a>
    

    
      <a href="https://linkedin.com/in/jrgardiner">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-linkedin fa-stack-1x"></i>
        </span>
      </a>
    
  </div>

  <div class="sidebar-item">
    <p>A site for my analyses, findings, musings and other helpful stuff.</p>
  </div>
  
  <ul>
    
    <li><a href="/blog/fitbit-data-analysis">Fitbit Data Analysis</a></li>
    
    <li><a href="/blog/police_data_api_in_leaflet_part2">Using the data.police.uk API with Leaflet - part 2</a></li>
    
    <li><a href="/blog/police_data_api_in_leaflet_part1">Using the data.police.uk API with Leaflet</a></li>
    
    <li><a href="/blog/a-basic-leaflet-map-in-jekyll">A basic Leaflet.js map in Jekyll</a></li>
    
  </ul>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    
	
    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About me</a>
        
      
    
    <!--<a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>-->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">James Gardiner</a>
            <br />
            <small>A blog for all things data</small>
          </h3>
        </div>
      </div>
      <div class="container content">
	    <div class="post">
  <h1 class="post-title">Fitbit Data Analysis</h1>
  <span class="post-date">03 Apr 2016</span>
  <p>For Christmas I was lucky enough to get a <a href="https://www.fitbit.com/uk/chargehr">Fitbit Charge HR</a> from my wife. The fact that I’d previously asked for one to ‘do data analysis on’ slightly mystified and amused her, but she still went ahead and suprised me with it!</p>

<p>I’ve been hoping to use the monitor as a way to personalise an analysis of data, to see how the results feel when they relate to me (and especially my health), rather than some data that are abstract from me as an indivdual. If at the same time I can view my own health through new tools, then it’s a bonus.</p>

<p>Here I outline how I go about storing and analysing the heart rate data generated by the device using Postgres, Pandas and a Jupyter notebook.</p>

<hr />
<!--more-->

<h3 id="charge-hr">Charge HR</h3>

<p>In terms of sensors, the Charge HR is well equipped: it has an optical heart rate monitor, a 3-axis accelerometer and an altimeter. These produce high resolution heart rate (hr) data, length of time asleep (and quality of sleep), floors climbed and an estimate of the number of minutes the wearer is ‘active’ for a day. This is all pretty comprehensive, but for this post I’m focussing on my hr data, and in particular what Fitbit calls <em>intraday</em> data, which are heart rate data at up to 1 second resolution.</p>

<h3 id="accessing-the-data">Accessing the Data</h3>
<p>There are two ways to get access to intraday data. Either pay $49.99 a year on a <a href="https://www.fitbit.com/premium/export">Fitbit Premium subscription</a> which allows export of the data in CSV format, or gather the data using <a href="https://dev.fitbit.com/docs/heart-rate/">Fitbit’s API</a>. Obviously I’m not going to pay to get data when I can do the same for free, but I think there are some questions to be asked about requiring paid access to your own personally generated data if you lack the technical skills to gather them through an API.</p>

<p>In any case, to get the data I used the following method.</p>

<ol>
  <li>Sign up for the Fitbit API and register a ‘personal’ type app. The important aspects here are ensuring the <em>Browser</em> app type is selected and the callback url is set to <code class="highlighter-rouge">http://127.0.0.1:8080/</code>.</li>
  <li>Install <a href="https://github.com/orcasgit/python-fitbit">python-fitbit</a> into whatever Python environment you’re working with. At the time of writing, I needed to install from master on github rather than PyPi due to issues with OAUTH2 authentication. The fixed version may be released by the time you read this post.</li>
  <li>
    <p>Run the <code class="highlighter-rouge">gather_keys_oauth2.py</code> script available in the repo, passing it the client id and client secret for your app (which are available on the manage my apps page of the Fitbit site). Save the access token and refresh tokens in a file. I used a simple JSON file called tokens.json with the format:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nt">"ACCESS_TOKEN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURACCESSTOKEN"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"CLIENT_SECRET"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURCLIENTSECRET"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"REFRESH_TOKEN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURREFRESHTOKEN"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"CLIENT_ID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURCLIENTID"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre>
    </div>
  </li>
</ol>

<p>4.Clone my <a href="https://github.com/JamesGardiner/heart-rate-analysis"><code class="highlighter-rouge">heart_rate_analysis</code></a> repo, and run the <code class="highlighter-rouge">setup_hr_db.py</code> script. This requires postgres and a database called <code class="highlighter-rouge">fitbit</code> (though you can change the <code class="highlighter-rouge">connection_string</code> to something else if you want, the script relies on SQLAlchemy). I’m using Postgres as I wanted to try mixing SQL and JSON in a single database. If you’ve saved a <code class="highlighter-rouge">tokens.json</code> file in the same directory as this script, it will read in your keys from there, otherwise specify their location in main().</p>

<h3 id="analysis-in-jupyter-with-pandas">Analysis in Jupyter with Pandas</h3>
<p>I looked at the data using the ubiquitous <a href="http://jupyter.org/">Jupyter Notebooks</a>, and I’ve saved the basic investigative analyses I’ve done on these data to the repo in the link above (click through to see the rendered noteboom on GitHub.</p>

<p>The basic flow is:</p>

<ol>
  <li>Connect to the db using <a href="http://initd.org/psycopg/">psycopg2</a></li>
  <li>
    <p>Using SQL, expand the JSON Arrays to individual JSON values:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> SELECT r_hr,
        DATE,
        Jsonb_array_elements(hr) #&gt; '{time}'  AS TIME,
        Jsonb_array_elements(hr) #&gt; '{value}' AS value
 FROM heart_rate
</code></pre>
    </div>
  </li>
  <li>Read these into <a href="http://pandas.pydata.org/">pandas</a> as a dataframe</li>
  <li>Reset the index as datetime objects</li>
</ol>

<p>This then allows you to slice, dice and resample the data using time periods and dates, for example going from all the data:</p>

<p><img src="/assets/all_hr.png" alt="All recorded heart beats" /></p>

<p>to daily means:</p>

<p><img src="/assets/avg_hr.png" alt="Average heart rate and resting heart rate" /></p>

<p>is just one line of code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Resample to day using mean</span>
<span class="n">dfrsmpl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s">'D'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
</code></pre>
</div>

<p>If you’ve cloned my repo, you can use <a href="https://github.com/JamesGardiner/heart-rate-analysis/blob/master/heart_rate_analysis.ipynb">this notebook</a> to run the same analyses on your own data.</p>

<h3 id="next-steps">Next steps</h3>
<p>I don’t have much in the way of a time series yet, and it will be interesting to see how my heart rate changes over time (especially in relation to periods of the year where I’ll be doing more or less exercise, i.e. Christmas).</p>

<p>Obviously this is only one aspect of the data collected by the Charge HR, and it might be possible to look at correlations between other data and my heart rate, but at the moment, I don’t have any hard plans to do huge amounts of analysis on what is really a pet project. If that changes, I’ll add some further blog posts.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/police_data_api_in_leaflet_part2">
            Using the data.police.uk API with Leaflet - part 2
            <small>05 May 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/police_data_api_in_leaflet_part1">
            Using the data.police.uk API with Leaflet
            <small>05 May 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/a-basic-leaflet-map-in-jekyll">
            A basic Leaflet.js map in Jekyll
            <small>04 Apr 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

	    <a href="https://twitter.com/share" class="twitter-share-button" data-via="<_JamesRG>">Tweet</a>

<!-- Put this just before the closing body tag -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	    <!-- disquss file -->

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jamesgardiner'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <div class="footer">
          <p>
          &copy; James Gardiner 2016. All rights reserved.
          </p>
        </div>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
	
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
