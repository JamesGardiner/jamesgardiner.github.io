<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Software engineer">

    <title>Fitbit Data Analysis - James Gardiner</title>

    <link rel="canonical" href="http://localhost:4000/blog/fitbit-data-analysis">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="James Gardiner" />

</head>

 



 <!-- CSS -->




<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">James Gardiner</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                <li>
                    <a href="/blog">Blog</a>
                </li>
                
				
                <li>
                    <a href="/contact/">Contact</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/svalbard.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Fitbit Data Analysis</h1>
                    
                    <span class="meta">Posted by James Gardiner on April 3, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>For Christmas I was lucky enough to get a <a href="https://www.fitbit.com/uk/chargehr">Fitbit Charge HR</a> from my wife. The fact that I’d previously asked for one to ‘do data analysis on’ slightly mystified and amused her, but she still went ahead and suprised me with it!</p>

<p>I’ve been hoping to use the monitor as a way to personalise an analysis of data, to see how the results feel when they relate to me (and especially my health), rather than some data that are abstract from me as an indivdual. If at the same time I can view my own health through new tools, then it’s a bonus.</p>

<p>Here I outline how I go about storing and analysing the heart rate data generated by the device using Postgres, Pandas and a Jupyter notebook.</p>

<hr />
<!--more-->

<h3 id="charge-hr">Charge HR</h3>

<p>In terms of sensors, the Charge HR is well equipped: it has an optical heart rate monitor, a 3-axis accelerometer and an altimeter. These produce high resolution heart rate (hr) data, length of time asleep (and quality of sleep), floors climbed and an estimate of the number of minutes the wearer is ‘active’ for a day. This is all pretty comprehensive, but for this post I’m focussing on my hr data, and in particular what Fitbit calls <em>intraday</em> data, which are heart rate data at up to 1 second resolution.</p>

<h3 id="accessing-the-data">Accessing the Data</h3>
<p>There are two ways to get access to intraday data. Either pay $49.99 a year on a <a href="https://www.fitbit.com/premium/export">Fitbit Premium subscription</a> which allows export of the data in CSV format, or gather the data using <a href="https://dev.fitbit.com/docs/heart-rate/">Fitbit’s API</a>. Obviously I’m not going to pay to get data when I can do the same for free, but I think there are some questions to be asked about requiring paid access to your own personally generated data if you lack the technical skills to gather them through an API.</p>

<p>In any case, to get the data I used the following method.</p>

<ol>
  <li>Sign up for the Fitbit API and register a ‘personal’ type app. The important aspects here are ensuring the <em>Browser</em> app type is selected and the callback url is set to <code class="highlighter-rouge">http://127.0.0.1:8080/</code>.</li>
  <li>Install <a href="https://github.com/orcasgit/python-fitbit">python-fitbit</a> into whatever Python environment you’re working with. At the time of writing, I needed to install from master on github rather than PyPi due to issues with OAUTH2 authentication. The fixed version may be released by the time you read this post.</li>
  <li>Run the <code class="highlighter-rouge">gather_keys_oauth2.py</code> script available in the repo, passing it the client id and client secret for your app (which are available on the manage my apps page of the Fitbit site). Save the access token and refresh tokens in a file. I used a simple JSON file called tokens.json with the format:</li>
</ol>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"ACCESS_TOKEN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURACCESSTOKEN"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"CLIENT_SECRET"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURCLIENTSECRET"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"REFRESH_TOKEN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURREFRESHTOKEN"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"CLIENT_ID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOURCLIENTID"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>4.Clone my <a href="https://github.com/JamesGardiner/heart-rate-analysis"><code class="highlighter-rouge">heart_rate_analysis</code></a> repo, and run the <code class="highlighter-rouge">setup_hr_db.py</code> script. This requires postgres and a database called <code class="highlighter-rouge">fitbit</code> (though you can change the <code class="highlighter-rouge">connection_string</code> to something else if you want, the script relies on SQLAlchemy). I’m using Postgres as I wanted to try mixing SQL and JSON in a single database. If you’ve saved a <code class="highlighter-rouge">tokens.json</code> file in the same directory as this script, it will read in your keys from there, otherwise specify their location in main().</p>

<h3 id="analysis-in-jupyter-with-pandas">Analysis in Jupyter with Pandas</h3>
<p>I looked at the data using the ubiquitous <a href="http://jupyter.org/">Jupyter Notebooks</a>, and I’ve saved the basic investigative analyses I’ve done on these data to the repo in the link above (click through to see the rendered noteboom on GitHub.</p>

<p>The basic flow is:</p>

<ol>
  <li>Connect to the db using <a href="http://initd.org/psycopg/">psycopg2</a></li>
  <li>Using SQL, expand the JSON Arrays to individual JSON values:</li>
</ol>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">r_hr</span><span class="p">,</span>
       <span class="n">DATE</span><span class="p">,</span>
       <span class="n">Jsonb_array_elements</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="o">#&gt;</span> <span class="s1">'{time}'</span>  <span class="k">AS</span> <span class="n">TIME</span><span class="p">,</span>
       <span class="n">Jsonb_array_elements</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="o">#&gt;</span> <span class="s1">'{value}'</span> <span class="k">AS</span> <span class="n">value</span>
<span class="k">FROM</span> <span class="n">heart_rate</span>
</code></pre>
</div>

<ol>
  <li>Read these into <a href="http://pandas.pydata.org/">pandas</a> as a dataframe</li>
  <li>Reset the index as datetime objects</li>
</ol>

<p>This then allows you to slice, dice and resample the data using time periods and dates, for example going from all the data:</p>

<p><img src="/img/all_hr.png" alt="All recorded heart beats" /></p>

<p>to daily means:</p>

<p><img src="/img/avg_hr.png" alt="Average heart rate and resting heart rate" /></p>

<p>is just one line of code:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Resample to day using mean</span>
<span class="n">dfrsmpl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s">'D'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
</code></pre>
</div>

<p>If you’ve cloned my repo, you can use <a href="https://github.com/JamesGardiner/heart-rate-analysis/blob/master/heart_rate_analysis.ipynb">this notebook</a> to run the same analyses on your own data.</p>

<h3 id="next-steps">Next steps</h3>
<p>I don’t have much in the way of a time series yet, and it will be interesting to see how my heart rate changes over time (especially in relation to periods of the year where I’ll be doing more or less exercise, i.e. Christmas).</p>

<p>Obviously this is only one aspect of the data collected by the Charge HR, and it might be possible to look at correlations between other data and my heart rate, but at the moment, I don’t have any hard plans to do huge amounts of analysis on what is really a pet project. If that changes, I’ll add some further blog posts.</p>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/police_data_api_in_leaflet_part2" data-toggle="tooltip" data-placement="top" title="Using the data.police.uk API with Leaflet - part 2">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blog/read_sql_pandas" data-toggle="tooltip" data-placement="top" title="Connecting to Postrges with Pandas and Jupyter">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/_JamesRG">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.linkedin.com/in/jrgardiner">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/JamesGardiner">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:james@jgardiner.co.uk">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; J Gardiner Consulting Ltd. 2017</p>
                
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
